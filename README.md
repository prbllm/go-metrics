# Go Metrics

Система сбора и хранения метрик, состоящая из сервера метрик и агента для сбора runtime метрик Go приложений.

## Описание

Go Metrics - это система для сбора, хранения и мониторинга метрик. Проект включает в себя:

- **Сервер метрик** - HTTP API сервер для приема и хранения метрик
- **Агент** - клиент для сбора runtime метрик Go приложений и отправки их на сервер
- **In-memory хранилище** - быстрый доступ к метрикам в памяти
- **REST API** - простой HTTP интерфейс для работы с метриками

## Архитектура

Система построена по принципу клиент-сервер:

```
┌─────────────────┐    HTTP POST    ┌─────────────────┐
│   Agent         │ ──────────────► │   Server        │
│   (Collector)   │                 │   (API)         │
│                 │                 │                 │
│ • Runtime stats │                 │ • Store metrics │
│ • Poll interval │                 │ • REST API      │
│ • Report data   │                 │ • In-memory DB  │
└─────────────────┘                 └─────────────────┘
```

### Компоненты

- **Agent** (`cmd/agent/`) - собирает runtime метрики Go приложения
- **Server** (`cmd/server/`) - HTTP сервер для приема и хранения метрик
- **Storage** (`internal/repository/`) - in-memory хранилище метрик
- **Service** (`internal/service/`) - бизнес-логика работы с метриками
- **Handler** (`internal/handler/`) - HTTP обработчики запросов

## Установка и запуск

### Требования

- Go 1.24.5 или выше
- Git

### Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/prbllm/go-metrics.git
cd go-metrics
```

2. Установите зависимости:
```bash
go mod download
```

### Запуск сервера

```bash
# Запуск с параметрами по умолчанию (localhost:8080)
go run cmd/server/main.go

# Запуск с кастомным адресом
go run cmd/server/main.go -a localhost:9090
```

### Запуск агента

```bash
# Запуск агента (по умолчанию отправляет метрики на localhost:8080)
go run cmd/agent/main.go

# Запуск с кастомными параметрами
go run cmd/agent/main.go -a localhost:9090 -r 5 -p 1
```

### Параметры командной строки

**Сервер:**
- `-a` - адрес сервера (по умолчанию: localhost:8080)

**Агент:**
- `-a` - адрес сервера для отправки метрик (по умолчанию: localhost:8080)
- `-r` - интервал отправки метрик в секундах (по умолчанию: 10)
- `-p` - интервал сбора метрик в секундах (по умолчанию: 2)

## API Документация

### Endpoints

#### 1. Обновление метрики
```
POST /update/{metricType}/{metricName}/{metricValue}
```

**Параметры:**
- `metricType` - тип метрики (`gauge` или `counter`)
- `metricName` - имя метрики
- `metricValue` - значение метрики

**Примеры:**
```bash
# Обновление gauge метрики
curl -X POST http://localhost:8080/update/gauge/Alloc/12345.67

# Обновление counter метрики
curl -X POST http://localhost:8080/update/counter/PollCount/1
```

#### 2. Получение значения метрики
```
GET /value/{metricType}/{metricName}
```

**Параметры:**
- `metricType` - тип метрики (`gauge` или `counter`)
- `metricName` - имя метрики

**Пример:**
```bash
curl http://localhost:8080/value/gauge/Alloc
```

#### 3. Получение всех метрик
```
GET /
```

**Пример:**
```bash
curl http://localhost:8080/
```

### Типы метрик

- **Gauge** - метрики с плавающей точкой (например, использование памяти)
- **Counter** - счетчики с целочисленными значениями (например, количество запросов)

### Собираемые метрики

Агент автоматически собирает следующие runtime метрики Go:

**Memory метрики:**
- `Alloc` - текущее количество байт, выделенных в куче
- `HeapAlloc` - количество байт, выделенных в куче
- `HeapIdle` - количество байт в неиспользуемых span'ах кучи
- `HeapInuse` - количество байт в используемых span'ах кучи
- `HeapObjects` - количество объектов в куче
- `HeapReleased` - количество байт, возвращенных операционной системе
- `HeapSys` - количество байт, полученных от операционной системы
- `TotalAlloc` - общее количество байт, выделенных в куче

**GC метрики:**
- `GCCPUFraction` - доля времени выполнения программы, потраченного на GC
- `GCSys` - количество байт памяти, используемой для системных структур GC
- `LastGC` - время последней сборки мусора
- `NextGC` - время следующей сборки мусора
- `NumForcedGC` - количество принудительных сборок мусора
- `NumGC` - количество сборок мусора
- `PauseTotalNs` - общее время пауз GC в наносекундах

**System метрики:**
- `BuckHashSys` - количество байт, используемых для хеш-таблиц
- `Frees` - количество освобождений памяти
- `Lookups` - количество указателей, разрешенных во время выполнения
- `Mallocs` - количество выделений памяти
- `MCacheInuse` - количество байт в используемых mcache структурах
- `MCacheSys` - количество байт, полученных от ОС для mcache структур
- `MSpanInuse` - количество байт в используемых mspan структурах
- `MSpanSys` - количество байт, полученных от ОС для mspan структур
- `OtherSys` - количество байт, используемых для других системных структур
- `StackInuse` - количество байт в стеке
- `StackSys` - количество байт, полученных от ОС для стека
- `Sys` - общее количество байт, полученных от ОС

**Custom метрики:**
- `PollCount` - счетчик количества сборок метрик
- `RandomValue` - случайное значение для тестирования

## Запуск автотестов

Для успешного запуска автотестов называйте ветки `iter<number>`, где `<number>` — порядковый номер инкремента. Например, в ветке с названием `iter4` запустятся автотесты для инкрементов с первого по четвёртый.

При мёрже ветки с инкрементом в основную ветку `main` будут запускаться все автотесты.

Подробнее про локальный и автоматический запуск читайте в [README автотестов](https://github.com/Yandex-Practicum/go-autotests).

## Структура проекта

```
go-metrics/
├── cmd/                    # Точки входа приложения
│   ├── agent/             # Агент для сбора метрик
│   │   ├── main.go        # Основной файл агента
│   │   └── maint_test.go  # Тесты агента
│   └── server/            # HTTP сервер
│       ├── main.go        # Основной файл сервера
│       └── main_test.go   # Тесты сервера
├── internal/              # Внутренние пакеты приложения
│   ├── agent/             # Логика агента
│   │   ├── agent.go       # Основная логика агента
│   │   ├── collector.go   # Сборщик runtime метрик
│   │   └── *_test.go      # Тесты
│   ├── config/            # Конфигурация
│   │   ├── config.go      # Структуры конфигурации
│   │   ├── flags.go       # Парсинг флагов командной строки
│   │   └── routes.go      # Определение маршрутов API
│   ├── handler/           # HTTP обработчики
│   │   ├── handlers.go    # HTTP обработчики запросов
│   │   └── *_test.go      # Тесты обработчиков
│   ├── model/             # Модели данных
│   │   └── metrics.go     # Структуры метрик
│   ├── repository/        # Слой доступа к данным
│   │   ├── interfaces.go  # Интерфейсы репозитория
│   │   └── memstorage.go  # In-memory хранилище
│   └── service/           # Бизнес-логика
│       ├── interfaces.go  # Интерфейсы сервисов
│       ├── metrics.go     # Сервис метрик
│       ├── validator.go   # Валидация данных
│       └── *_test.go      # Тесты сервисов
├── migrations/            # Миграции базы данных
├── pkg/                   # Публичные пакеты
├── go.mod                 # Go модуль
├── go.sum                 # Зависимости
└── README.md              # Документация
```

### Архитектурные принципы

Проект следует принципам **Clean Architecture** с разделением на слои:

- **Presentation Layer** (`cmd/`, `internal/handler/`) - HTTP API и точки входа
- **Business Logic Layer** (`internal/service/`) - бизнес-логика приложения
- **Data Access Layer** (`internal/repository/`) - работа с данными
- **Domain Layer** (`internal/model/`) - модели предметной области

### Основные компоненты

- **Agent** - собирает runtime метрики Go приложения и отправляет их на сервер
- **Server** - HTTP API сервер для приема и хранения метрик
- **Storage** - in-memory хранилище для быстрого доступа к метрикам
- **Service** - бизнес-логика обработки метрик
- **Handler** - HTTP обработчики для REST API

## Примеры использования

### Запуск полной системы

1. **Запустите сервер:**
```bash
go run cmd/server/main.go
```

2. **В другом терминале запустите агент:**
```bash
go run cmd/agent/main.go
```

3. **Проверьте работу системы:**
```bash
# Получить все метрики
curl http://localhost:8080/

# Получить конкретную метрику
curl http://localhost:8080/value/gauge/Alloc

# Отправить кастомную метрику
curl -X POST http://localhost:8080/update/gauge/CustomMetric/123.45
```

### Мониторинг в реальном времени

Агент автоматически собирает и отправляет следующие метрики каждые 10 секунд:

- **Memory usage** - использование памяти приложением
- **GC statistics** - статистика сборки мусора
- **System metrics** - системные метрики Go runtime
- **Custom counters** - счетчики для мониторинга

## Разработка

### Запуск тестов

```bash
# Запуск всех тестов
go test ./...

# Запуск тестов с покрытием
go test -cover ./...

# Запуск тестов конкретного пакета
go test ./internal/service/
```

### Сборка

```bash
# Сборка сервера
go build -o bin/server cmd/server/main.go

# Сборка агента
go build -o bin/agent cmd/agent/main.go
```

### Линтинг

```bash
# Запуск линтера
golangci-lint run

# Запуск go vet
go vet ./...
```

## Лицензия

MIT License
